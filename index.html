<html>

    <head>
        <title>Stocks</title>
        <meta charset="UTF-8" />
        <link  rel="stylesheet" href="https://bootswatch.com/readable/bootstrap.min.css">
        <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
        <script src="https://unpkg.com/react@latest/dist/react.js"></script>
        <script src="https://unpkg.com/react-dom@latest/dist/react-dom.js"></script>
        <script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/node-uuid/1.4.8/uuid.min.js"></script>
    </head>

    <body>
        <h1 id="title">Hello</h1>
        <style>
            #title {
                text-align: center;
            }

        </style>

        <div id="root"></div>

        <script type="text/babel">

            var Stocks = React.createClass({

                getInitialState: function(){
                   return {
                        ticker: [],
                        sockets: []
                   }
                },

                componentDidMount: function(){

                },

                getTicker: function(itemData){

                    var ticker = this.state.ticker;
                    ticker[0] = itemData;
                    this.setState({ticker: ticker});
                },

                getSocket: function(socket){

                    for (var i = 0; i < this.state.sockets.length; i++){
                        this.state.sockets[i].disconnect();
                    }
                    var sockets = this.state.sockets;
                    sockets.push(socket);
                    this.state.sockets = sockets;
                },

                render: function(){

                    var randomId = uuid.v4();
                    var ticker = this.state.ticker;
                    var item = ticker.map(item => {
                        return <Item key={randomId} ticker={item} randomId={randomId} getS={this.getSocket}/>
                    })

                    return (
                        <div>
                            <Search getT={this.getTicker}/>
                            <div className="container"><h5>Updates every 20 seconds...</h5></div>
                            {item}
                        </div>
                    )
                }
            });

            var Search = React.createClass({


                searchTicker: function(e){

                    if(this.refs.searchText.value === ''){
                        alert('Ticker is required');
                    } else {

                        this.setState({searchValue: this.refs.searchText.value}, function(){

                            this.props.getT(this.state.searchValue);
                        });     
                    }
                    e.preventDefault();
                },

                render: function(){

                    return (
                        <div className="container">
                            <div className="jumbotron">
                                <h3 className="text-center">Search For Any Ticker</h3>
                                <form ref="searchForm" onSubmit={this.searchTicker} >
                                    <input type="text" className="form-control" ref="searchText" placeholder="Search Ticker" />
                                    <input type="submit" className="btn btn-primary" value="Submit" />
                                </form>
                                
                            </div>
                        </div>
                    )
                }
            });
            
            var Item = React.createClass({

                getInitialState: function(){
                    return {
                        socket: io('http://localhost:3000'),
                        ticker: this.props.ticker
                    }
                },

                componentDidMount: function(){

                    var socket = this.state.socket;
                    this.props.getS(socket);
                    socket.emit('ticker', this.props.ticker);

                },

                render: function(){

                    var self = this;
                    var socket = this.state.socket;
                    var ticker = this.state.ticker;

                    socket.on(ticker, function(data){
                        self.setState({volume: data.volume});
                    });

                    socket.on('invalid', function(){
                        socket.emit('invalid');
                        self.setState({ticker: 'Invalid Ticker...'});
                        alert('Invalid Ticker!');
                    })

                    return (
                        <div>
                             <div className="container">
                                <div className="jumbotron">
                                    <h3>{this.state.ticker}</h3>
                                    <h4>{this.state.volume}</h4>
                                    <button type="button" className="btn btn-default">News</button>
                                </div>
                            </div>
                        </div>
                    )
                }
            });
            
            ReactDOM.render(<Stocks />, document.getElementById('root'));

      </script>
    </body>
</html>